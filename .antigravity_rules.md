# Flutter Health Management App - Development Guidelines

## Project Context

This is a Flutter mobile application for Android that helps users manage their health with a focus on weight loss. The app provides health tracking, nutrition management, exercise tracking, and clinical safety features.

**Tech Stack:**
- Platform: Android (API 24-34)
- Framework: Flutter 3.24.0+ (LTS)
- Language: Dart 3.3.0+
- Architecture: Feature-First Clean Architecture
- State Management: Riverpod
- Database: Hive (local storage)

## Architecture Standards

### Feature-First Clean Architecture

Follow three-layer architecture for each feature:

```
lib/features/{feature_name}/
├── data/          # Models, repositories impl, datasources
├── domain/        # Entities, repository interfaces, use cases
└── presentation/  # Pages, widgets, providers
```

**Critical Rules:**
- Presentation → Domain → Data (one-way dependency)
- Domain layer: NO external dependencies (pure Dart only)
- Features MUST NOT import from other features
- Shared code goes in `lib/core/`
- Cross-feature communication via domain events or shared core services

### Core Layer

```
lib/core/
├── constants/    # App-wide constants
├── errors/       # Failures, exceptions
├── utils/        # Utility functions
├── widgets/      # Reusable widgets
└── providers/    # Global Riverpod providers
```

## Naming Conventions

- **Files/Folders**: `snake_case` (e.g., `health_tracking_repository.dart`)
- **Classes**: `PascalCase` (e.g., `HealthTrackingRepository`)
- **Variables/Methods**: `camelCase` (e.g., `calculateMovingAverage()`)
- **Constants**: `lowerCamelCase` with `k` prefix (e.g., `kDefaultMovingAverageDays`)
- **Private**: `_camelCase` (e.g., `_calculateAverage()`)

## Error Handling - CRITICAL

**Always use `Either<Failure, T>` for operations that can fail:**

```dart
typedef Result<T> = Either<Failure, T>;

// Use cases return Result
Result<double> call(List<HealthMetric> metrics) {
  if (metrics.isEmpty) {
    return Left(ValidationFailure('Metrics list cannot be empty'));
  }
  return Right(calculatedValue);
}

// Repositories return Future<Result>
Future<Result<HealthMetric>> saveHealthMetric(HealthMetric metric) async {
  try {
    final saved = await localDataSource.saveHealthMetric(metric);
    return Right(saved);
  } on HiveError catch (e) {
    return Left(DatabaseFailure('Failed to save: ${e.message}'));
  }
}
```

**Failure Types:**
- `ValidationFailure` - Input validation errors
- `NetworkFailure` - Network/API errors (post-MVP)
- `DatabaseFailure` - Database/Hive errors
- `PermissionFailure` - Permission errors
- `NotFoundFailure` - Resource not found
- `CacheFailure` - Cache errors

**NEVER throw exceptions in domain layer** - always return `Result<T>`.

## State Management with Riverpod

**Provider Patterns:**

```dart
// Future provider for async data
final weightMetricsProvider = FutureProvider<List<HealthMetric>>((ref) async {
  final repository = ref.watch(healthTrackingRepositoryProvider);
  return await repository.getHealthMetrics();
});

// State provider for simple state
final selectedDateProvider = StateProvider<DateTime>((ref) => DateTime.now());

// StateNotifier for complex state
final healthMetricsNotifierProvider = StateNotifierProvider<HealthMetricsNotifier, List<HealthMetric>>((ref) {
  return HealthMetricsNotifier(ref.watch(healthTrackingRepositoryProvider));
});
```

**Best Practices:**
- Keep state local when possible (use `StatefulWidget` for UI-only state)
- Use providers for business logic and data fetching
- Avoid deep provider dependency chains
- Always handle error states in providers

## Import Organization

Order imports:
1. Dart SDK (`dart:async`, `dart:math`)
2. Flutter (`package:flutter/material.dart`)
3. Packages (`package:riverpod/riverpod.dart`)
4. Project (relative paths)

## Code Quality

- Use `flutter_lints` with strict rules
- Fix ALL linter warnings before committing
- Avoid `dynamic` types - use explicit types
- Always handle null cases explicitly
- Prefer immutable data structures
- Use `const` constructors when possible

## Performance Best Practices

- Use `ListView.builder` for large lists
- Limit chart data points (max 100)
- Dispose controllers and subscriptions
- Cache expensive calculations
- Use pagination for large datasets

## Git Commit Standards

**Format:**
```
<type>(<scope>): <subject>

<business-focused paragraph explaining why and user impact>

<technical paragraph with bullet points>
- Technical implementation detail 1
- Technical implementation detail 2
- Dependencies or system interactions
- Performance considerations

<footer with task reference>
```

**Types:** `feat`, `fix`, `docs`, `style`, `refactor`, `test`, `chore`, `perf`, `ci`, `build`

**Scopes:** `health-tracking`, `nutrition`, `exercise`, `core`, `llm`

**Rules:**
- Subject: Max 50 chars, imperative mood, capitalized, no period
- Task number in footer (e.g., `Refs FR-042`), NOT in subject
- Business first, technical second
- Use "Add" not "Added", "Fix" not "Fixed"

## Use Case Pattern

Each use case should:
1. Take entities/parameters as input
2. Return `Result<T>` (Either<Failure, T>)
3. Contain single business operation
4. Have no side effects (except through repository)
5. Be easily testable

## Widget Guidelines

- Use `ConsumerWidget` or `ConsumerStatefulWidget` for Riverpod
- Extract complex widgets into separate files
- Use `const` constructors when possible
- Implement proper error states
- Add loading indicators for async operations
- Follow Material Design 3 principles

## Clinical Safety Rules - CRITICAL

**Alerts to implement:**
- **Resting Heart Rate**: If > 100 BPM for 3 consecutive days → alert
- **Rapid Weight Loss**: If > 4 lbs/week for 2 consecutive weeks → alert
- **Poor Sleep**: If quality < 4/10 for 5 consecutive days → alert
- **Elevated Heart Rate**: If increases by > 20 BPM from baseline for 3 days → alert
  - Baseline: Average of first 7 days, recalculated monthly

**Data Calculations:**
- **7-Day Moving Average**: Average over last 7 days (inclusive of today)
- **Plateau Detection**: Weight unchanged for 3 consecutive weeks AND measurements unchanged
- **Macro Calculations**: By calories (protein/carbs: 4 cal/g, fats: 9 cal/g)

## MVP vs Post-MVP

**MVP Scope (Current):**
- Local-only (no cloud sync, no authentication)
- Hive database (local storage only)
- No LLM integration
- Core features: Health tracking, nutrition, exercise

**Post-MVP (Deferred):**
- Cloud sync (DreamHost PHP/MySQL backend)
- User authentication
- LLM integration
- Additional features (medication, behavioral support, advanced analytics)

**Important:** Architecture supports post-MVP, but implementation is deferred.

## Pre-Commit Checklist

Before committing, ensure:
- [ ] All tests pass
- [ ] No linter warnings
- [ ] Error handling implemented (using `Result<T>`)
- [ ] Documentation added (Dartdoc for public APIs)
- [ ] Follows naming conventions
- [ ] Follows architecture patterns (Feature-First Clean Architecture)
- [ ] Performance considerations addressed
- [ ] Commit message follows format
